name: Kairaa RDP Linux

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Desktop Environment and RDP Server
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies dbus-x11 x11-xserver-utils
          sudo apt-get install -y xrdp
          echo "exec startxfce4" | sudo tee /etc/xrdp/startwm.sh
          sudo systemctl restart xrdp
          sudo ufw allow 3389/tcp
          echo "Server RDP dan Desktop Environment berhasil diinstal."

      - name: Configure Runner User for RDP
        run: |
          # --- SOLUSI TERBAIK: Menggunakan pengguna bawaan 'runner' ---
          # Ini lebih sederhana, cepat, dan stabil.
          
          # Dapatkan nama pengguna bawaan (yaitu 'runner')
          RDP_USER=$(whoami)
          echo "Mengkonfigurasi pengguna bawaan: $RDP_USER"
          
          # Buat password yang aman untuk disalin (hanya alfanumerik)
          password=$(LC_ALL=C tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 16)
          
          # Atur password untuk pengguna 'runner'
          echo "$RDP_USER:$password" | sudo chpasswd
          
          # Tambahkan pengguna 'runner' ke grup 'ssl-cert' yang diperlukan oleh xrdp
          sudo adduser $RDP_USER ssl-cert
          
          # Ekspor variabel untuk digunakan di langkah selanjutnya
          echo "RDP_USER=$RDP_USER" >> $GITHUB_ENV
          echo "RDP_PASS=$password" >> $GITHUB_ENV
          
          echo "Pengguna '$RDP_USER' berhasil dikonfigurasi untuk RDP."

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID
          
          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 10 ]; do
              tsIP=$(tailscale ip -4)
              sleep 5
              retries=$((retries+1))
          done
          
          if [ -z "$tsIP" ]; then
              echo "Gagal mendapatkan alamat IP Tailscale. Keluar."
              exit 1
          fi
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          
          # Beri jeda 5 detik agar semua service siap
          echo "Menunggu 5 detik sebelum memverifikasi port RDP..."
          sleep 5
          
          if ! nc -zv ${{ env.TAILSCALE_IP }} 3389; then
              echo "Koneksi TCP ke port RDP 3389 gagal."
              exit 1
          fi
          echo "Konektivitas TCP berhasil!"

      - name: Maintain Connection
        run: |
          echo -e "\n=== AKSES RDP ==="
          echo "Alamat: ${{ env.TAILSCALE_IP }}"
          echo "Username: ${{ env.RDP_USER }}"
          echo "Password: ${{ env.RDP_PASS }}"
          echo "==================\n"
          
          while true; do
              echo "[$(date)] RDP Aktif - Gunakan Ctrl+C di workflow untuk menghentikan"
              sleep 300
          done
